"use strict";(self.webpackChunkdart_frog_docs=self.webpackChunkdart_frog_docs||[]).push([[566],{3905:(e,n,t)=>{t.d(n,{Zo:()=>d,kt:()=>m});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var i=a.createContext({}),c=function(e){var n=a.useContext(i),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},d=function(e){var n=c(e.components);return a.createElement(i.Provider,{value:n},e.children)},p={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},g=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,o=e.originalType,i=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),g=c(t),m=r,u=g["".concat(i,".").concat(m)]||g[m]||p[m]||o;return t?a.createElement(u,s(s({ref:n},d),{},{components:t})):a.createElement(u,s({ref:n},d))}));function m(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var o=t.length,s=new Array(o);s[0]=g;var l={};for(var i in n)hasOwnProperty.call(n,i)&&(l[i]=n[i]);l.originalType=e,l.mdxType="string"==typeof e?e:r,s[1]=l;for(var c=2;c<o;c++)s[c]=t[c];return a.createElement.apply(null,s)}return a.createElement.apply(null,t)}g.displayName="MDXCreateElement"},31:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>s,default:()=>p,frontMatter:()=>o,metadata:()=>l,toc:()=>c});var a=t(7462),r=(t(7294),t(3905));const o={sidebar_position:4,title:"\ud83d\udd0c WebSockets"},s="WebSockets \ud83d\udd0c",l={unversionedId:"advanced/web_socket",id:"advanced/web_socket",title:"\ud83d\udd0c WebSockets",description:"Dart Frog recently introduced package:dartfrogwebsocket to make working with WebSockets easier.",source:"@site/docs/advanced/web_socket.md",sourceDirName:"advanced",slug:"/advanced/web_socket",permalink:"/docs/advanced/web_socket",draft:!1,editUrl:"https://github.com/VeryGoodOpenSource/dart_frog/tree/main/docs/docs/advanced/web_socket.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4,title:"\ud83d\udd0c WebSockets"},sidebar:"docs",previous:{title:"\ud83d\udc33 Custom Dockerfile",permalink:"/docs/advanced/custom_dockerfile"},next:{title:"\ud83d\udd0b Powered By Header",permalink:"/docs/advanced/powered_by_header"}},i={},c=[{value:"Installation",id:"installation",level:2},{value:"Creating a WebSocket Handler",id:"creating-a-websocket-handler",level:2},{value:"Receiving Messages from the Client",id:"receiving-messages-from-the-client",level:2},{value:"Sending Messages from the Client",id:"sending-messages-from-the-client",level:2},{value:"Sending Messages from the Server",id:"sending-messages-from-the-server",level:2},{value:"Receiving Messages from the Server",id:"receiving-messages-from-the-server",level:2},{value:"Simplifying Things Further",id:"simplifying-things-further",level:2},{value:"Conclusion",id:"conclusion",level:2}],d={toc:c};function p(e){let{components:n,...t}=e;return(0,r.kt)("wrapper",(0,a.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"websockets-"},"WebSockets \ud83d\udd0c"),(0,r.kt)("p",null,"Dart Frog recently introduced ",(0,r.kt)("a",{parentName:"p",href:"https://pub.dev/packages/dart_frog_web_socket"},(0,r.kt)("inlineCode",{parentName:"a"},"package:dart_frog_web_socket"))," to make working with WebSockets easier."),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},"We added WebSocket support as a separate package to keep the Dart Frog package lightweight, containing only core functionality. In the future, we may add additional packages in order to extend the Dart Frog ecosystem without bloating the core.")),(0,r.kt)("h2",{id:"installation"},"Installation"),(0,r.kt)("p",null,"To get started, add the ",(0,r.kt)("inlineCode",{parentName:"p"},"dart_frog_web_socket")," package as a dependency to your existing Dart Frog project:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"dart pub add dart_frog_web_socket\n")),(0,r.kt)("h2",{id:"creating-a-websocket-handler"},"Creating a WebSocket Handler"),(0,r.kt)("p",null,"We can use the ",(0,r.kt)("inlineCode",{parentName:"p"},"webSocketHandler")," from ",(0,r.kt)("inlineCode",{parentName:"p"},"package:dart_frog_web_socket")," to manage WebSocket connections."),(0,r.kt)("p",null,"You can either create a new route handler or integrate with an existing handler. For simplicity, we'll first take a look at adding a new route handler specifically for WebSocket connections."),(0,r.kt)("p",null,"Start by creating a new route, ",(0,r.kt)("inlineCode",{parentName:"p"},"routes/ws.dart"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-dart"},"import 'package:dart_frog/dart_frog.dart';\n\nResponse onRequest(RequestContext context) {\n  return Response();\n}\n")),(0,r.kt)("p",null,"Next, instead of handling the request directly, we can create a WebSocket handler:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-dart"},"import 'package:dart_frog/dart_frog.dart';\nimport 'package:dart_frog_web_socket/dart_frog_web_socket.dart';\n\nFuture<Response> onRequest(RequestContext context) async {\n  final handler = webSocketHandler((channel, protocol) {\n    // TODO: react to new connections.\n  });\n  return handler(context);\n}\n")),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"We need to refactor the request handler to be ",(0,r.kt)("inlineCode",{parentName:"p"},"async")," and return a ",(0,r.kt)("inlineCode",{parentName:"p"},"Future<Response>")," when using the ",(0,r.kt)("inlineCode",{parentName:"p"},"webSocketHandler"),".")),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"webSocketHandler")," will handle upgrading ",(0,r.kt)("inlineCode",{parentName:"p"},"HTTP")," requests to WebSocket connections and provides an ",(0,r.kt)("inlineCode",{parentName:"p"},"onConnection")," callback which exposes the ",(0,r.kt)("inlineCode",{parentName:"p"},"WebSocketChannel")," as well as an optional subprotocol."),(0,r.kt)("h2",{id:"receiving-messages-from-the-client"},"Receiving Messages from the Client"),(0,r.kt)("p",null,"Next, we can subscribe to the stream of messages exposed by the ",(0,r.kt)("inlineCode",{parentName:"p"},"WebSocketChannel"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-dart"},"import 'package:dart_frog/dart_frog.dart';\nimport 'package:dart_frog_web_socket/dart_frog_web_socket.dart';\n\nFuture<Response> onRequest(RequestContext context) async {\n  final handler = webSocketHandler((channel, protocol) {\n    channel.stream.listen((message) {\n      // Handle incoming client messages.\n      print(message);\n    });\n  });\n  return handler(context);\n}\n")),(0,r.kt)("p",null,"For simplicity, we are just printing all messages sent by connected clients."),(0,r.kt)("p",null,"Before moving on, let's verify that a client is able to establish a connection and send a message to our server. To do this, we'll create a simple client in Dart."),(0,r.kt)("h2",{id:"sending-messages-from-the-client"},"Sending Messages from the Client"),(0,r.kt)("p",null,"Create a new directory called ",(0,r.kt)("inlineCode",{parentName:"p"},"example")," at the project root and create a ",(0,r.kt)("inlineCode",{parentName:"p"},"pubspec.yaml"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"name: example\npublish_to: none\n\nenvironment:\n  sdk: '>=2.18.0 <3.0.0'\n\ndependencies:\n  web_socket_channel: ^2.0.0\n")),(0,r.kt)("p",null,"Next, install the dependencies:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"dart pub get\n")),(0,r.kt)("p",null,"Now, create a ",(0,r.kt)("inlineCode",{parentName:"p"},"main.dart")," with the following contents:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-dart"},"import 'package:web_socket_channel/web_socket_channel.dart';\n\nvoid main() {\n  // Connect to the remote WebSocket endpoint.\n  final uri = Uri.parse('ws://localhost:8080/ws');\n  final channel = WebSocketChannel.connect(uri);\n\n  // Send a message to the server.\n  channel.sink.add('hello');\n}\n")),(0,r.kt)("p",null,"We're using ",(0,r.kt)("a",{parentName:"p",href:"https://pub.dev/packages/web_socket_channel"},(0,r.kt)("inlineCode",{parentName:"a"},"package:web_socket_channel"))," to connect to our Dart Frog ",(0,r.kt)("inlineCode",{parentName:"p"},"/ws")," endpoint. We can then send messages to the server by calling ",(0,r.kt)("inlineCode",{parentName:"p"},"add")," on the ",(0,r.kt)("inlineCode",{parentName:"p"},"WebSocketChannel")," sink."),(0,r.kt)("p",null,"We can run our Dart Frog dev server now:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"dart_frog dev\n")),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"Be sure to run ",(0,r.kt)("inlineCode",{parentName:"p"},"dart_frog dev")," from the project root.")),(0,r.kt)("p",null,"Once the server is running in a new terminal, we can run our example client to test the connection:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"dart example/main.dart\n")),(0,r.kt)("p",null,"We should see the message we sent in our server logs:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"\u2713 Running on http://localhost:8080 (1.3s)\nThe Dart VM service is listening on http://127.0.0.1:8181/YKEF_nbwOpM=/\nThe Dart DevTools debugger and profiler is available at: http://127.0.0.1:8181/YKEF_nbwOpM=/devtools/#/?uri=ws%3A%2F%2F127.0.0.1%3A8181%2FYKEF_nbwOpM%3D%2Fws\n[hotreload] Hot reload is enabled.\nhello\n")),(0,r.kt)("h2",{id:"sending-messages-from-the-server"},"Sending Messages from the Server"),(0,r.kt)("p",null,"Now, let's send a message back to the client from the server. We can do that by adding a message to the channel sink on the server just like we previously did on the client."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-dart"},"import 'package:dart_frog/dart_frog.dart';\nimport 'package:dart_frog_web_socket/dart_frog_web_socket.dart';\n\nFuture<Response> onRequest(RequestContext context) async {\n  final handler = webSocketHandler((channel, protocol) {\n    channel.stream.listen((message) {\n      // Handle incoming client messages.\n      print(message);\n    });\n\n    // Send a message back to the client.\n    channel.sink.add('hi');\n  });\n  return handler(context);\n}\n")),(0,r.kt)("h2",{id:"receiving-messages-from-the-server"},"Receiving Messages from the Server"),(0,r.kt)("p",null,"Lastly, we need to update the client code to subscribe to messages from the server."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-dart"},"import 'package:web_socket_channel/web_socket_channel.dart';\n\nvoid main() {\n  // Connect to the remote WebSocket endpoint.\n  final uri = Uri.parse('ws://localhost:8080/ws');\n  final channel = WebSocketChannel.connect(uri);\n\n  // Send a message to the server.\n  channel.sink.add('hello');\n\n  // Subscribe to messages from the server.\n  channel.stream.listen((message) {\n    print(message);\n  });\n}\n")),(0,r.kt)("p",null,"Once we save all the changes and let the server hot reload, we can run the client code again:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"dart example/main.dart\n")),(0,r.kt)("p",null,"And we should see the following output:"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Server")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"[hotreload] Hot reload is enabled.\nhello\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Client")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"hi\n")),(0,r.kt)("h2",{id:"simplifying-things-further"},"Simplifying Things Further"),(0,r.kt)("p",null,"To make things even simpler, we can refactor the route handler implementation in cases where the route is only managing WebSocket connections:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-dart"},"import 'package:dart_frog/dart_frog.dart';\nimport 'package:dart_frog_web_socket/dart_frog_web_socket.dart';\n\nHandler get onRequest {\n  return webSocketHandler((channel, protocol) {\n    channel.stream.listen((message) {\n      // Handle incoming client messages.\n      print(message);\n    });\n\n    // Send a message back to the client.\n    channel.sink.add('hi');\n  });\n}\n")),(0,r.kt)("h2",{id:"conclusion"},"Conclusion"),(0,r.kt)("p",null,"That's it! \ud83c\udf89"),(0,r.kt)("p",null,"We've successfully established a WebSocket connection between the Dart Frog server and a client. We've also demonstrated how messages can be streamed between a server and one or more clients."))}p.isMDXComponent=!0}}]);